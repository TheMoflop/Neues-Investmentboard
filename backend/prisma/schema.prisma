generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  brokers   Broker[]
  aktienideen Aktienidee[]
  alarme    Alarm[]
}

model Broker {
  id        Int      @id @default(autoincrement())
  name      String
  type      String   // Online, Bank, etc.
  notes     String?
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user      User     @relation(fields: [userId], references: [id])
  konten    Konto[]
}

model Konto {
  id           Int      @id @default(autoincrement())
  name         String
  accountNumber String?
  currency     String   @default("EUR")
  brokerId     Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  notes        String?
  // Relations
  broker       Broker   @relation(fields: [brokerId], references: [id])
  positionen   Position[]
  transaktionen Transaktion[]
  dokumente    Dokument[]
}

model Position {
  id           Int      @id @default(autoincrement())
  kontoId      Int
  assetType    String   // Aktie, ETF, Crypto, CFD
  symbol       String
  name         String?
  quantity     Float
  entryPrice   Float
  currentPrice Float?
  entryDate    DateTime
  fees         Float?   @default(0)
  leverage     Float?   @default(1)
  marginPrice  Float?
  positionValue Float?
  annualFees   Float?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?
  // Relations
  konto        Konto    @relation(fields: [kontoId], references: [id])
  transaktionen Transaktion[]
  histories    PositionHistory[]
  @@index([kontoId, symbol])
}

model Aktienidee {
  id           Int      @id @default(autoincrement())
  userId       Int
  symbol       String
  name         String
  strategie    String   // Kurzfristig, Mittelfristig, Langfristig
  branche      String?
  analyst      String?
  entryPrice   Float?
  kursziel     Float?
  reasoning    String?
  status       String   @default("Offen") // Offen, Umgesetzt, Verworfen
  capitalPercentage Float?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  // Relations
  user         User     @relation(fields: [userId], references: [id])
  bewertungen  KiBewertung[]
  tranchen     Tranche[]
  news         News[]
  @@index([userId, symbol])
}

model Alarm {
  id           Int      @id @default(autoincrement())
  userId       Int
  positionId   Int?
  symbol       String
  name         String
  typ          String   // Preis, Prozent, Volume
  schwelle     Float
  richtung     String   // Über, Unter
  status       String   @default("Aktiv") // Aktiv, Ausgelöst, Pausiert
  channel      String   @default("InApp") // InApp, Discord, Email
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ausgeloestAt DateTime?
  // Relations
  user         User     @relation(fields: [userId], references: [id])
  position     Position? @relation(fields: [positionId], references: [id])
  @@index([userId, status])
model Tranche {
  id             Int      @id @default(autoincrement())
  aktienideeId   Int
  type           String   // kurz, mittel, lang
  entryCriteria  String?
  entryPrice     Float?
  investedPercentage Float?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  // Relations
  aktienidee     Aktienidee @relation(fields: [aktienideeId], references: [id])
}
model Dokument {
  id           Int      @id @default(autoincrement())
  kontoId      Int
  type         String   // PDF, CSV, OCR, ...
  filePath     String
  importDate   DateTime @default(now())
  status       String?
  notes        String?
  // Relations
  konto        Konto    @relation(fields: [kontoId], references: [id])
}
model News {
  id        Int      @id @default(autoincrement())
  symbol    String
  source    String
  headline  String
  content   String
  date      DateTime
  sentiment String?
  // Relations
  aktienideeId Int?
  aktienidee   Aktienidee? @relation(fields: [aktienideeId], references: [id])
}
model PositionHistory {
  id           Int      @id @default(autoincrement())
  positionId   Int
  changeType   String   // created, updated, deleted
  changedAt    DateTime @default(now())
  oldValue     Json?
  newValue     Json?
  // Relations
  position     Position @relation(fields: [positionId], references: [id])
}
}

model Transaktion {
  id           Int      @id @default(autoincrement())
  kontoId      Int
  positionId   Int?
  typ          String   // Kauf, Verkauf, Dividende, Gebühr
  symbol       String
  quantity     Float?
  price        Float
  fees         Float?   @default(0)
  datum        DateTime
  description  String?
  createdAt    DateTime @default(now())
  
  // Relations
  konto        Konto    @relation(fields: [kontoId], references: [id])
  position     Position? @relation(fields: [positionId], references: [id])
  
  @@index([kontoId, datum])
}

model KiBewertung {
  id                Int      @id @default(autoincrement())
  aktienideeId      Int
  symbol            String
  scoreFundamental  Float?   // 1-10
  scoreTechnisch    Float?   // 1-10
  scoreKombiniert   Float?   // 1-10
  kommentar         String?
  createdAt         DateTime @default(now())
  
  // Relations
  aktienidee        Aktienidee @relation(fields: [aktienideeId], references: [id])
  
  @@index([aktienideeId, createdAt])
}
